<!DOCTYPE html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<html>

<head>
  <!-- <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script> -->
  <!-- <script src="https://unpkg.com/axios/dist/axios.min.js"></script> -->
  <script src="dev_resources/vue.js"></script>
  <script src="dev_resources/axios.min.js"></script>
  <link rel="stylesheet" href="LALU_flat.css">
</head>

<body>
  <div class="tblHtIE9Fix detailItemsDiv ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom" id="detailItemsDiv0" role="tabpanel" style="display: block; visibility: visible;">
    <div class="detailItems ">
      <table class="detailItemTable sortable0 sortable" id="detailItemTable0">
        <thead>
          <tr>
            <th v-for="col in columns" v-on:click="sortTable(col)" :class="['detailItemsTable_' + col]">{{col}}
              <div class="arrow" v-if="col == sortColumn" v-bind:class="ascending ? 'arrow_up' : 'arrow_down'"></div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="row in rows" class="detailItemsTableRow">
            <td v-for="col in columns" :class="['detailItemsTable_' + col]">
              <div :class="['asyncField' + col]">{{row[col]}}</div>
            </td>
          </tr>
        </tbody>
        <tfoot></tfoot>
      </table>
    </div>
  </div>
</body>
<script type="text/javascript">
var BASEWSURL = "https://lalu.sirsi.net/lalu_ilsws/"; // Put your WS url here.
var CLIENTID = "DS_CLIENT";

var idDescription = function (data) {
  var baseArray = new Array();
  for (var i = 0; i < data.length; i++) {
    var policyID = data[i]['policyID'];
    var policyDescription = data[i]['policyDescription'];
    baseArray[policyID] = policyDescription;
  };
  return baseArray;
};

var getLocation = function () {
  var locationWsURL = BASEWSURL + "rest/admin/lookupLocationPolicyList?clientID=" + CLIENTID + "&json=true";
  return axios.get(locationWsURL).then(response => response.data.policyInfo).then(response => idDescription(response));
};

var getLibrary = function () {
  var libraryWsURL = BASEWSURL + "rest/admin/lookupLibraryPolicyList?clientID=" + CLIENTID + "&json=true";
  return axios.get(libraryWsURL).then(response => response.data.policyInfo).then(response => idDescription(response));
};

var getMaterial = function () {
  var materialTypeWsURL = BASEWSURL + "rest/admin/lookupItemTypePolicyList?clientID=" + CLIENTID + "&json=true";
  return axios.get(materialTypeWsURL).then(response => response.data.policyInfo).then(response => idDescription(response));
};

var getTitleInfo = function (rId) {
  // var titleID = $J("#" + rId + "_DOC_ID .DOC_ID_value").text().split(":")[1];
  var titleID = "2247614"; // just for develompment, remove later
  var titleInfoWsURL = BASEWSURL + "rest/standard/lookupTitleInfo?clientID=" + CLIENTID + "&titleID=" + titleID + "&includeMarcHoldings=true&includeCatalogingInfo=true&includeAvailabilityInfo=true&includeOrderInfo=true&includeBoundTogether=true&includeCallNumberSummary=true&marcEntryFilter=ALL&includeItemInfo=true&json=true&includeOPACInfo=true";
  return axios.get(titleInfoWsURL).then(response => response.data).then(data => parseTitleInfo(data));
};

var parseTitleInfo = function (data) {
  var interestingData = {};
  var CallInfo = data["TitleInfo"][0]["CallInfo"];
  for (var i = 0; i < CallInfo.length; i++) {
    interestingData[i] = {};
    interestingData[i]["numberOfCopies"] = CallInfo[i]["numberOfCopies"];
    interestingData[i]["libraryID"] = CallInfo[i]["libraryID"];
    interestingData[i]["callNumber"] = CallInfo[i]["callNumber"];
    interestingData[i]["itemTypeID"] = CallInfo[i]["ItemInfo"][0]["itemTypeID"];
    interestingData[i]["currentLocationID"] = CallInfo[i]["ItemInfo"][0]["currentLocationID"];
    interestingData[i]["publicNote"] = CallInfo[i]["ItemInfo"][0]["publicNote"];
    var epochDue = new Date(CallInfo[i]["ItemInfo"][0]["dueDate"]);
    var dueDate = epochDue.getMonth() + "/" + epochDue.getDate() + "/" + epochDue.getFullYear()
    interestingData[i]["dueDate"] = dueDate;
  };
  return interestingData;
};

var replaceText = function (locationDict, materialDict, libraryDict, titleDict) {
  titleDict.then(function (item) {
    console.log(item);
    for (var key in item) {
      if (item.hasOwnProperty(key)) {
        console.log(key);
        console.log("next");
        var shortLocation = item[key]['currentLocationID'];
        var shortType = item[key]['itemTypeID'];
        var shortLibrary = item[key]['libraryID'];
        locationDict.then(function (thing) {
          console.log(thing[shortLocation]);
          item[key]['currentLocationID'] = thing[shortLocation];
        });
        materialDict.then(function (thing) {
          console.log(thing[shortType]);
          item[key]['itemTypeID'] = thing[shortType];
        })
        libraryDict.then(function (thing) {
          console.log(thing[shortLibrary]);
          item[key]['libraryID'] = thing[shortLibrary];
        })
        return item;
      }
    };
  });
};

var mergeTitleInfo = function () {
  var locationDict = getLocation();
  var materialDict = getMaterial();
  var libraryDict = getLibrary();
  var titleDict = getTitleInfo('detail0');
  return Promise.all([locationDict, materialDict, libraryDict, titleDict])
    .then(function () {
      // console.log(locationDict, materialDict, libraryDict, titleDict);
      // return {locationDict, materialDict, libraryDict, titleDict};
      return replaceText(locationDict, materialDict, libraryDict, titleDict);
      // return replaceText(locationDict, materialDict, libraryDict, titleDict);
    });
};

var vueTable = new Vue({
  el: "#detailItemTable0",
  created: function () {
    this.titleInfo = mergeTitleInfo();
  },
  data: {
    ascending: false,
    titleInfo: '',
    sortColumn: "",

    rows: [
      { "Library": 1, "Material Type": "Chandler Bing", "Call Number": "305-917-1301", "Copy": 1, "Current Location": "IT Manager", "Note": "over there", "Request Item": "Missing" },
      { "Library": 2, "Material Type": "Ross Geller", "Call Number": "210-684-8953", "Current Location": "Paleontologist", "Copy": 5, "Note": "something", "Status": "Found" },
      { "Library": 3, "Material Type": "Rachel Green", "Call Number": "765-338-0312", " Current Location": "Waitress", "Copy": 4, "Note": "what", },
      { "Library": 4, "Material Type": "Monica Geller", "Call Number": "714-541-3336", "Current Location": "Head Chef", "Note": "message", },
      { "Library": 5, "Material Type": "Joey Tribbiani", "Call Number": "972-297-6037", "Current Location": "Actor", "Copy": 0, },
      { "Library": 6, "Material Type": "Phoebe Buffay", "Call Number": "760-318-8376", "Current Location": "Masseuse" }
    ],
  },
  methods: {
    "sortTable": function sortTable(col) {
      if (this.sortColumn === col) {
        this.ascending = !this.ascending;
      } else {
        this.ascending = true;
        this.sortColumn = col;
      }
      var ascending = this.ascending;
      this.rows.sort(function (a, b) {
        if (a[col] > b[col]) {
          return ascending ? 1 : -1
        } else if (a[col] < b[col]) {
          return ascending ? -1 : 1
        }
        return 0;
      })
    }
  },
  computed: {
    "columns": function columns() {
      if (this.rows.length == 0) {
        return [];
      }
      return Object.keys(this.rows[0])
    },
  },

});
</script>

</html>