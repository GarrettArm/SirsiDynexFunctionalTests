{
  "entryCode" : "MARCHOLDINGSTABLE",
  "names" : [
    {
      "value" : "MARC Holdings Table",
      "key" : "en_US"
    }
  ],
  "description" : "Adds fields to the MARC Holdings table, such as call number",
  "hiddenFields" : [
    "DOC_ID"
  ],
  "customJavaScript" : "var locationMap = {};\nvar materialTypeMap = {};\nvar libraryMap = {};\nvar baseWsURL = 'https://lalu.sirsi.net/lalu_ilsws/'; // Put your WS url here.\nvar clientID = 'DS_CLIENT';\nvar libraryDone = false;\nvar materialTypeDone = false;\nvar locationDone = false;\nvar maxAttempts = 10;\nvar curAttempt = 0;\nvar htmlFinalOrderOutput = '';\nvar htmlFinalHoldingOutput = '';\nvar holdingShelfMark ='';\nvar textualHoldings ='';\nvar textualHoldingsEnumeration ='';\nvar textualHoldingsSupplemental ='';\nvar textualHoldingsIndexes = '';\n\nfunction startUpdatedMARCHoldings(rId) {\n\n\n    getDetailPolicies();\n    \n    waitDetailMARCHoldings(rId);\n}\n\nfunction waitDetailMARCHoldings(rId) {\n\n\n    if (!(libraryDone == true && materialTypeDone == true && locationDone == true)) {\n        curAttempt++;\n        if (curAttempt <= maxAttempts) {\n            setTimeout(function() {\n         waitDetailMARCHoldings(rId);\n         }, 250);\n        }\n    } else {\n\n        goDetailMARCHoldings(rId);\n    }\n}\n\n\nfunction goDetailMARCHoldings(rId) {\n\n    var numRows = 0;\n\n\tvar hitNum = rId.split('detail')[1];\n        var catKey = $J('#'+rId+'_DOC_ID .DOC_ID_value').text().split(':')[1];\n        var attachTarget = jQuery('#detail_accordion'+hitNum+ ' h3:contains(\"Holdings\")').next();\n        var wsURL = baseWsURL + 'rest/standard/lookupTitleInfo?clientID=' + clientID + '&titleID=' + catKey + '&includeMarcHoldings=true&marcEntryFilter=ALL&json=true&callback=?';\n\n        $J.getJSON(wsURL, function(tr) {\n            \n                        //Add MARC Holdings Info\n\n            var holdingsInfo = tr.TitleInfo[0].MarcHoldingsInfo;\n\n            if (holdingsInfo) {\n\n              var htmlHoldingOutput = '';\n              \n              $J.each(holdingsInfo, function(holdingIndex, holding){\n                var holdingLibID = this.holdingLibraryID;\n                var holdingLibDesc = libraryMap[holdingLibID];\n                \n                var holdingEntry = this.MarcEntryInfo;\n                \n                $J.each(holdingEntry, function(holdingEntryIndex, holdingEntryData){\n\n                var entryId = this.entryID;\n                \n                if (entryId === '852') {\n                 var holdingLocationText = this.text;\n                 holdingLocation = holdingLocationText.split('--')[0];\n                 holdingLocationDesc = locationMap[holdingLocation];\n                 holdingShelfMark = holdingLocationText.split('--')[1];\n                 \n                 }\n\n                 if (entryId === '866') {\n                 textualHoldings += this.text + '<br />';\n                 }\n\n                 if (entryId === '863') {\n                 textualHoldingsEnumeration += this.text + '<br />';\n                 }\n            \n                 if (entryId === '867') {\n                 textualHoldingsSupplemental += this.label + ': ' + this.text + '<br />';\n                 }\n\n                 if (entryId === '868') {\n                 textualHoldingsIndexes += this.label + ': ' + this.text + '<br />';\n                 }\n\n                });\n                \n                htmlHoldingOutput += '<tr class=\"detailItemsTableRow\"><td>' + holdingLocationDesc + '<\/td><td>' + holdingShelfMark + '<\/td><td>' + textualHoldings + textualHoldingsEnumeration + textualHoldingsSupplemental + textualHoldingsIndexes +'<\/td><\/tr>';\n             \n             //empty the variables\n             textualHoldings = '';\n             textualHoldingsEnumeration = '';\n             textualHoldingsSupplemental = '';\n             textualHoldingsIndexes = '';\n\n             });\n             \n              \n             } // end if holdingsInfo\n             else {\n             htmlHoldingOutput = '';\n             }\n\n\n\n            // End Add MARC Holdings Info\n\n            \n\n        if (htmlHoldingOutput !== '') {\n\n            //change holdings table column headers - probably custom for each site \n            $J(\".detailHoldingsDiv .detailItemTable_th:contains('Library')\").text('Location');\n            $J(\".detailHoldingsDiv .detailItemTable_th:contains('Shelf Location')\").text('Call Number');\n            $J(attachTarget).find('tbody').html(htmlHoldingOutput);\n\n            \n        }\n\n          \n\n        });\n\n\n\n}\n\n\n\nfunction getDetailPolicies() {\n    var locationWsURL = baseWsURL + 'rest/admin/lookupLocationPolicyList?clientID=' + clientID + '&json=true&callback=?';\n    var libraryWsURL = baseWsURL + 'rest/admin/lookupLibraryPolicyList?clientID=' + clientID + '&json=true&callback=?';\n    var materialTypeWsURL = baseWsURL + 'rest/admin/lookupItemTypePolicyList?clientID=' + clientID + '&json=true&callback=?';\n    $J.getJSON(locationWsURL, function(locationData) {\n        $J.each(locationData.policyInfo, function(index, value) {\n            locationMap[this.policyID] = this.policyDescription;\n\n        });\n        locationDone = true;\n    });\n\n    $J.getJSON(libraryWsURL, function(libraryData) {\n        $J.each(libraryData.policyInfo, function(index, value) {\n            libraryMap[this.policyID] = this.policyDescription;\n        });\n        libraryDone = true;\n\n    });\n    $J.getJSON(materialTypeWsURL, function(materialTypeData) {\n        $J.each(materialTypeData.policyInfo, function(index, value) {\n            materialTypeMap[this.policyID] = this.policyDescription;\n        });\n        materialTypeDone = true;\n    });\n}",
  "htmlContent" : "<script type=\"text/javascript\">\nstartUpdatedMARCHoldings('$RESULT_ID');\n<\/script>"
}