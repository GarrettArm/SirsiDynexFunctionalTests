{
  "hiddenFields" : [
    "DOC_ID"
  ],
  "names" : [
    {
      "value" : "Available Table redo",
      "key" : "en_US"
    }
  ],
  "description" : "Rebuilds the Available table from scratch.  Can pull in any data from Webservices calls.",
  "entryCode" : "AVAILABLETABLEREDO",
  "type" : "STANDARD",
  "customJavaScript" : "var BASEWSURL = 'https://lalu.sirsi.net/lalu_ilsws/'; // Put your WS url here.\r\nvar CLIENTID = 'DS_CLIENT';\r\n\r\nvar ajaxResponseController;\r\nvar updateAvailableTable = function(rId) {\r\n  $J('tbody tr td.detailItemsTable_ITEMNOTE').text('');\r\n  var policyDict = getPolicies();\r\n  var titleInfo = getTitleInfo(rId);\r\n  ajaxResponseController = setInterval(function() {\r\n    waitDetailMARCHoldings(rId, policyDict, titleInfo);\r\n  }, 800);\r\n};\r\n\r\nvar getPolicies = function() {\r\n  var locationMap = {};\r\n  var libraryMap = {};\r\n  var materialTypeMap = {};\r\n  var locationWsURL = BASEWSURL + 'rest/admin/lookupLocationPolicyList?clientID=' + CLIENTID + '&json=true&callback=?';\r\n  var libraryWsURL = BASEWSURL + 'rest/admin/lookupLibraryPolicyList?clientID=' + CLIENTID + '&json=true&callback=?';\r\n  var materialTypeWsURL = BASEWSURL + 'rest/admin/lookupItemTypePolicyList?clientID=' + CLIENTID + '&json=true&callback=?';\r\n  $J.getJSON(locationWsURL, function(locationData) {\r\n    $J.each(locationData.policyInfo, function() {\r\n      locationMap[this.policyID] = this.policyDescription;\r\n    });\r\n  });\r\n  $J.getJSON(libraryWsURL, function(libraryData) {\r\n    $J.each(libraryData.policyInfo, function() {\r\n      libraryMap[this.policyID] = this.policyDescription;\r\n    });\r\n  });\r\n  $J.getJSON(materialTypeWsURL, function(materialTypeData) {\r\n    $J.each(materialTypeData.policyInfo, function() {\r\n      materialTypeMap[this.policyID] = this.policyDescription;\r\n    });\r\n  });\r\n  return {\r\n    locationMap: locationMap,\r\n    libraryMap: libraryMap,\r\n    materialTypeMap: materialTypeMap\r\n  };\r\n};\r\n\r\nvar getTitleInfo = function(rId) {\r\n  var titleInfo = {};\r\n  var catKey = $J('#' + rId + '_DOC_ID .DOC_ID_value').text().split(':')[1];\r\n  var titleInfoWsURL = BASEWSURL + 'rest/standard/lookupTitleInfo?clientID=' + CLIENTID + '&titleID=' + catKey + '&includeMarcHoldings=true&includeCatalogingInfo=true&includeAvailabilityInfo=true&includeOrderInfo=true&includeBoundTogether=true&includeCallNumberSummary=true&marcEntryFilter=ALL&includeItemInfo=true&json=true&includeOPACInfo=true&callback=?'\r\n  $J.getJSON(titleInfoWsURL, function(data) {\r\n    var parsedTitleInfo = parseTitleInfo(data);\r\n    titleInfo['interestingData'] = parsedTitleInfo;\r\n  })\r\n  return titleInfo\r\n};\r\n\r\nvar parseTitleInfo = function(data) {\r\n  var interestingData = {};\r\n  var CallInfo = data['TitleInfo'][0]['CallInfo'];\r\n  for (var i = 0; i < CallInfo.length; i++) {\r\n    interestingData[i] = {};\r\n    interestingData[i]['numberOfCopies'] = CallInfo[i]['numberOfCopies'];\r\n    interestingData[i]['libraryID'] = CallInfo[i]['libraryID'];\r\n    interestingData[i]['callNumber'] = CallInfo[i]['callNumber'];\r\n    interestingData[i]['itemTypeID'] = CallInfo[i]['ItemInfo'][0]['itemTypeID'];\r\n    interestingData[i]['currentLocationID'] = CallInfo[i]['ItemInfo'][0]['currentLocationID'];\r\n    interestingData[i]['publicNote'] = CallInfo[i]['ItemInfo'][0]['publicNote'];\r\n    var epochDue = new Date(CallInfo[i]['ItemInfo'][0]['dueDate']);\r\n    var dueDate = epochDue.getMonth() + '/' + epochDue.getDate() + '/' + epochDue.getFullYear()\r\n    interestingData[i]['dueDate'] = dueDate;\r\n  };\r\n  return interestingData;\r\n};\r\n\r\nvar waitDetailMARCHoldings = function(rId, policyDict, titleInfo) {\r\n  if ((titleInfo) && ('interestingData' in titleInfo) && (policyDict['locationMap'])) {\r\n    makeAvailableTable(policyDict, titleInfo);\r\n    clearInterval(ajaxResponseController);\r\n  };\r\n};\r\n\r\nvar makeAvailableTable = function(policyDict, titleInfo) {\r\n  var itemData = titleInfo['interestingData'];\r\n  var htmlAvailableOutput = `<div class=\"detailItems\"><table class=\"detailItemTable sortable0 sortable\" id=\"detailItemTable0\">\r\n      <thead>\r\n        <tr>\r\n          <th class=\"detailItemsTable_LIBRARY\">\r\n            <div class=\"detailItemTable_th\">Library<\/div>\r\n          <\/th>\r\n          <th class=\"detailItemsTable_ITYPE\">\r\n            <div class=\"detailItemTable_th\">Material Type<\/div>\r\n          <\/th>\r\n          <th class=\"detailItemsTable_CALLNUMBER\">\r\n            <div class=\"detailItemTable_th\">Call Number<\/div>\r\n          <\/th>\r\n          <th class=\"detailItemsTable_NOTE\">\r\n            <div class=\"detailItemTable_th\">Note<\/div>\r\n          <\/th>\r\n          <th class=\"detailItemsTable_COPY\">\r\n            <div class=\"detailItemTable_th\">Copy<\/div>\r\n          <\/th>\r\n          <th class=\"detailItemsTable_SD_ITEM_STATUS\">\r\n            <div class=\"detailItemTable_th\">Status<\/div>\r\n          <\/th>\r\n        <\/tr>\r\n      <\/thead>\r\n      <tbody>`\r\n  for (var row in itemData) {\r\n    if (itemData.hasOwnProperty(row)) {\r\n      var newRow = makeRow(itemData, row, policyDict);\r\n      htmlAvailableOutput += newRow;\r\n    };\r\n  };\r\n  htmlAvailableOutput += '<\/tbody><tfoot><\/tfoot><\/table><\/div>';\r\n  $J('#detailItemsDiv0').html(htmlAvailableOutput);\r\n};\r\n\r\nvar makeRow = function(itemData, row, policyDict) {\r\n  var library = policyDict['libraryMap'][itemData[row]['libraryID']];\r\n  var material = policyDict['materialTypeMap'][itemData[row]['itemTypeID']];\r\n  var callNum = itemData[row]['callNumber'];\r\n  var location = policyDict['locationMap'][itemData[row]['currentLocationID']];\r\n  if (location.indexOf('Material has been checked out.') !== -1) {\r\n    location += ' ' + itemData[row]['dueDate'];\r\n  };\r\n  if (itemData[row]['publicNote'] && itemData[row]['publicNote'].length) {\r\n    var note = itemData[row]['publicNote'];\r\n  } else {\r\n    var note = '';\r\n  };\r\n  var copies = itemData[row]['numberOfCopies'];\r\n  var newRow = '<tr class=\"detailItemsTableRow\">';\r\n  newRow += '<td class=\"detailItemsTable_LIBRARY\"><div class=\"asyncFieldLIBRARY\" id=\"asyncFielddetailItemsDiv0LIBRARY31518013572072\">' + library + '<\/div><div class=\"asyncFieldLIBRARY hidden\" id=\"asyncFieldDefaultdetailItemsDiv0LIBRARY31518013572072\">' + library + '<\/div><\/td>';\r\n  newRow += '<td class=\"detailItemsTable_ITYPE\">' + material + '<\/td>';\r\n  newRow += '<td class=\"detailItemsTable_CALLNUMBER\">' + callNum + '<\/td>';\r\n  newRow += '<td class=\"detailItemsTable_NOTE\">' + note + '<\/td>';\r\n  newRow += '<td class=\"detailItemsTable_COPY\">' + copies + '<\/td>';\r\n  newRow += '<td class=\"detailItemsTable_SD_ITEM_STATUS\"><div class=\"asyncFieldSD_ITEM_STATUS\" id=\"asyncFielddetailItemsDiv0SD_ITEM_STATUS31518013572072\">' + location + '<\/div><div class=\"asyncFieldSD_ITEM_STATUS hidden\" id=\"asyncFieldDefaultdetailItemsDiv0SD_ITEM_STATUS31518013572072\">Unknown<\/div><\/td>';\r\n  return newRow;\r\n}\r\n",
  "compatibility" : "DESKTOP_AND_MOBILE",
  "htmlContent" : "<script type=\"text/javascript\">\r\nupdateAvailableTable('$RESULT_ID');\r\n<\/script>"
}